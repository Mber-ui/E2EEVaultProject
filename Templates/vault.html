{% extends "layout.html" %}
{% block content %}

<h2>Your Secure Vault</h2>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="banner">{{ messages[0] }}</div>
  {% endif %}
{% endwith %}

<!-- Encrypted File List -->
<article class="vault-card">
    <h3><i class="bi bi-folder-lock"></i> Encrypted Files</h3>

    {% if encrypted_files %}
        {% for f in encrypted_files %}
        <div class="file-row">
            <div class="file-label">
                <i class="bi bi-file-earmark-lock"></i>
                <span>{{ f }}</span>
            </div>
            <form method="POST" action="/decrypt">
                <input type="hidden" name="file" value="{{ f }}">
                <button type="submit" class="secondary">Decrypt</button>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <p>No encrypted files yet.</p>
    {% endif %}
</article>

<!-- Upload Section -->
<article class="vault-card">
    <h3><i class="bi bi-upload"></i> Upload & Encrypt New File</h3>

    <!-- Drag & Drop -->
    <div id="drop-zone" class="drop-zone">
        <i class="bi bi-cloud-arrow-up" style="font-size: 2.5rem;"></i>
        <p>Drag & drop a file here or click to browse</p>
    </div>

    <!-- Hidden File Input -->
    <form id="upload-form" action="/encrypt" method="post" enctype="multipart/form-data" style="display:none;">
        <input type="file" id="file-input" name="file" required>
        <button type="submit">Encrypt</button>
    </form>
</article>

<script>
    const zone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("file-input");
    const uploadForm = document.getElementById("upload-form");

    zone.addEventListener("click", () => fileInput.click());

    zone.addEventListener("dragover", e => {
        e.preventDefault();
        zone.classList.add("dragover");
    });

    zone.addEventListener("dragleave", () => {
        zone.classList.remove("dragover");
    });

    zone.addEventListener("drop", e => {
        e.preventDefault();
        zone.classList.remove("dragover");

        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            uploadForm.submit();
        }
    });

    fileInput.addEventListener("change", () => uploadForm.submit());
</script>

{% endblock %}
